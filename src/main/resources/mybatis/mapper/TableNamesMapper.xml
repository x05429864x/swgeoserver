<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.siweidg.swgeoserver.dao.TableNamesMapper">

	<sql id="table">tablenames</sql>

	<!-- 定义的resultMap，可以解决类的属性名和数据库列名不一致的问题-->
	<resultMap id="TableNamesMap" type="com.siweidg.swgeoserver.entry.TableNames">
		<id property="id" column="id" jdbcType="BIGINT"/>
		<result property="nameCn" column="name_cn" jdbcType="VARCHAR" />
		<result property="nameEn" column="name_en" jdbcType="VARCHAR"  />
		<result property="workspace" column="workspace" jdbcType="VARCHAR"  />
		<result property="datastore" column="datastore" jdbcType="VARCHAR"  />
		<result property="state" column="state" jdbcType="BIGINT"  />
		<result property="creater" column="creater" jdbcType="BIGINT"  />
		<result property="createTime" column="create_time"  jdbcType="TIMESTAMP"/>
		<result property="updater" column="updater" jdbcType="BIGINT"  />
		<result property="updateTime" column="update_time"  jdbcType="TIMESTAMP"/>
		<result property="remark" column="remark" jdbcType="VARCHAR"  />
		<result property="flag" column="flag" jdbcType="INTEGER"  />
		<result property="metadata" column="metadata" javaType="Object" typeHandler="com.siweidg.swgeoserver.entry.JsonTypeHandler" />
		<!-- 关联对象 -->
		<association property="style" javaType="com.siweidg.swgeoserver.entry.Style">
			<!-- 关联条件Tablenames的style_id对应着Style的id -->
			<id column="styleId" property="styleId"/>
			<result column="styleNameCn" property="styleNameCn"/>
			<result column="styleNameEn" property="styleNameEn"/>
			<!--<result column="sWorkspace" property="corkspace"/>
			<result column="sCreater" property="creater"/>
			<result column="sCreateTime" property="createTime"/>
			<result column="sRemark" property="remark"/>
			<result column="sFlag" property="flag"/>-->
		</association>
	</resultMap>




	<select id="getByIds" resultType="TableNames" >
		select * from <include refid="table"/> where id in
		<foreach collection="array" item="item" index="index" open="(" separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 根据Name查询表名-->
	<select id="getByName" resultType="TableNames">
		select * from <include refid="table"/>
		<if test="_parameter != null">
			<where>
				name_cn = '${nameCn}' or name_en = '${nameEn}'
			</where>
		</if>
		order by id
	</select>

	<!-- 根据Name查询表名-->
	<select id="getByNameCn" resultType="TableNames">
		select * from <include refid="table"/>
		<if test="_parameter != null">
			<where>
				name_cn = '${nameCn}'
			</where>
		</if>
		order by id
	</select>

	<!-- 根据英文查询中文名称-->
	<select id="getTableNameByNameEn" resultType="TableNames">
		select * from <include refid="table"/>
		<if test="_parameter != null">
			<where>
				name_en like '%${nameEn}%'
			</where>
		</if>
		order by id
	</select>

	<!-- 新增 -->
	<insert id="insertTableNames" parameterType="TableNames"
			keyColumn="id" keyProperty="id" useGeneratedKeys="true" >
		insert into <include refid="table"/>(name_cn,name_en,workspace,datastore,creater,create_time,updater,update_time,state,remark,flag,metadata)
		values (#{nameCn},#{nameEn},#{workspace},#{datastore},#{creater},#{createTime},#{updater},#{updateTime},#{state},#{remark},#{flag},#{metadata,javaType=Object,jdbcType=OTHER,typeHandler=com.siweidg.swgeoserver.entry.JsonTypeHandler})
	</insert>

	<!-- 更新 -->
	<update id="updateTableNames" parameterType="TableNames">
		UPDATE <include refid="table"/>
		<trim prefix="set" suffixOverrides=",">
			<if test="nameCn!=null and nameCn !=''">name_cn=#{nameCn},</if>
			<if test="nameEn!=null and nameEn !=''">name_en=#{nameEn},</if>
			<if test="workspace!=null and workspace !=''">workspace=#{workspace},</if>
			<if test="datastore!=null and datastore !=''">datastore=#{datastore},</if>
			<if test="creater!=null">creater=#{creater},</if>
			<if test="createTime!=null">create_time=#{createTime},</if>
			<if test="updater!=null and updater !=''">updater=#{updater},</if>
			<if test="updateTime!=null">update_time=#{updateTime},</if>
			<if test="state!=null and state !=''">state=#{state},</if>
			<if test="remark!=null and remark !=''">remark=#{remark},</if>
			<if test="flag!=null and flag !=''">flag=#{flag},</if>
			<if test="metadata!=null">metadata=#{metadata,javaType=Object,jdbcType=OTHER,typeHandler=com.siweidg.swgeoserver.entry.JsonTypeHandler},</if>
			<if test="styleId!=null">style_id=#{styleId},</if>
		</trim>
		WHERE id = #{id}
	</update>

	<!-- 删除 -->
	<delete id="delete" parameterType="Long">
		delete from <include refid="table"/> where id = #{id}
	</delete>

	<!-- 删除数据库中表-->
	<update id="dropTable" parameterType="String">
		<if test="_parameter != null">
			drop table ${names}
		</if>
	</update>

	<select id="findTableNames" resultMap="TableNamesMap">
		select t.id,t.name_cn,t.name_en,t.workspace,t.state,t.creater,t.create_time,t.updater,t.update_time,t.remark,t.flag,t.datastore,t.metadata
		,s.id styleId,s.name_cn styleNameCn,s.name_en styleNameEn from tablenames t left join sys_style s on t.style_id = s.id where 1=1
			<if test="state != null">
				<foreach collection="state" item="state" open="AND (" close=")" separator="or" >
					t.state = #{state}
				</foreach>
			</if>
			<if test="nameCn != null">
				AND t.name_cn = #{nameCn}
			</if>
		order by t.id
	</select>

	<select id="getExtent"  parameterType="Long" resultType="String">
		SELECT ST_Extent(the_geom) from workdata_base where task_id = ${taskId}
	</select>

	<!-- 作废
	<update id="updateState" parameterType="Long[]">
		<if test="_parameter != null">
			UPDATE <include refid="table"/> SET state = 1 ,update_time = now() where id in
			<foreach collection="array" item="id" index="index" open="(" separator="," close=")" >
				#{id}
			</foreach>
		</if>
	</update>
	-->

	<!-- 查询数据库中已经导入的表名 -->
	<!--<select id="findTableName" resultType="java.lang.String">
		SELECT tablename FROM pg_tables	WHERE tablename NOT LIKE 'pg%' AND tablename NOT LIKE 'sql_%' and tablename not like '%tablenames%' and schemaname = 'public'
	</select>-->


	<!-- 删除对照表数据
	<delete id="deleteTableNames" parameterType="Long[]">
		delete from <include refid="table"/> where id in
		<foreach collection="array" item="id" index="index" open="(" separator="," close=")" >
			#{id}
		</foreach>
	</delete>
    -->

</mapper>

